<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login & Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="logo.jpg" type="image/x-icon">
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Section -->
    <div id="loginSection" class="login-view">
        <div class="login-container">
            <div class="login-header">
                <div style="margin-bottom: 20px; display: inline-block;">
                    <div style="width: 80px; height: 80px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="fas fa-user-shield" style="font-size: 35px; color: white;"></i>
                    </div>
                </div>
                <h2>Admin Login</h2>
                <p>Please sign in to access the dashboard</p>
            </div>
            <form id="loginForm">
                <div class="input-group">
                    <label for="adminUsername" style="text-align: left; display: block;"><i class="fas fa-user-circle" style="margin-right: 6px;"></i>Username</label>
                    <div style="position: relative;">
                        <i class="fas fa-user" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
                        <input type="text" id="adminUsername" class="input-field" style="padding-left: 40px;" placeholder="Enter your username" required autocomplete="username">
                    </div>
                </div>
                <div class="input-group">
                    <label for="adminPassword" style="text-align: left; display: block;"><i class="fas fa-lock" style="margin-right: 6px;"></i>Password</label>
                    <div style="position: relative;">
                        <i class="fas fa-key" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
                        <input type="password" id="adminPassword" class="input-field" style="padding-left: 40px;" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                </div>
                <button type="submit" id="loginBtn" class="btn btn-primary btn-full" style="margin-top: 15px; padding: 16px;">
                    <i class="fas fa-sign-in-alt" style="margin-right: 10px;"></i>
                    <span id="loginBtnText">Sign In</span>
                </button>
                <div id="loginStatus" class="status-message" style="text-align: left;"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" style="display:none;">
        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title"><i class="fas fa-th-large" style="margin-right: 12px; color: var(--secondary-color);"></i>Admin Dashboard</h1>
                <div class="user-info">
                    <span><i class="fas fa-user-shield" style="margin-right: 8px; color: var(--primary-color);"></i>Welcome, <strong id="adminName">Admin</strong></span>
                    <button onclick="logout()" class="btn btn-outline"><i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Logout</button>
                </div>
            </div>
            
            <!-- Debug Panel for Production Issues -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid var(--secondary-color);">
                <div class="card-header">
                    <h3><div class="card-icon"><i class="fas fa-tools"></i></div>System Status</h3>
                    <p>API connection and environment information</p>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong>Environment:</strong> 
                            <span id="envStatus" style="margin-left: 8px; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;"></span>
                        </div>
                        <div>
                            <strong>API URL:</strong> 
                            <code id="apiUrlDisplay" style="background: #f1f3f4; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;"></code>
                        </div>
                        <div>
                            <strong>Protocol:</strong> 
                            <span id="protocolStatus" style="margin-left: 8px; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;"></span>
                        </div>
                    </div>
                    <button onclick="testApiConnection()" class="btn btn-outline" style="margin-right: 10px;">
                        <i class="fas fa-wifi"></i> Test API Connection
                    </button>
                    <button onclick="debugLog('Current configuration', { apiUrl: API_BASE_URL, hostname: window.location.hostname, protocol: window.location.protocol })" class="btn btn-outline">
                        <i class="fas fa-bug"></i> Log Debug Info
                    </button>
                </div>
            </div>

            <div class="admin-actions">
                <!-- Register Student -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-user-plus"></i></div>Register Student</h3>
                        <p>Add a new student to the system</p>
                    </div>
                    <form id="registerStudentForm">
                        <div class="form-group">
                            <label for="studentName"><i class="fas fa-user" style="margin-right: 6px;"></i>Full Name</label>
                            <input type="text" id="studentName" class="input-field" placeholder="Enter student's full name" required>
                        </div>
                        <div class="form-group">
                            <label for="studentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="studentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-group">
                            <label for="studentCourse"><i class="fas fa-book" style="margin-right: 6px;"></i>Course</label>
                            <input type="text" id="studentCourse" class="input-field" placeholder="Enter course name" required>
                        </div>
                        <div class="form-group">
                            <label for="studentYearSemester"><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>Level of Study</label>
                            <input type="text" id="studentYearSemester" class="input-field" placeholder="e.g., Year 2 Semester 1" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentNationalId"><i class="fas fa-id-card" style="margin-right: 6px;"></i>National ID</label>
                                <input type="text" id="studentNationalId" class="input-field" placeholder="Enter national ID">
                            </div>
                            <div class="form-group">
                                <label for="studentBirthCert"><i class="fas fa-certificate" style="margin-right: 6px;"></i>Birth Certificate</label>
                                <input type="text" id="studentBirthCert" class="input-field" placeholder="Enter birth certificate number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentDob"><i class="fas fa-birthday-cake" style="margin-right: 6px;"></i>Date of Birth</label>
                                <input type="date" id="studentDob" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="studentPassword"><i class="fas fa-lock" style="margin-right: 6px;"></i>Password</label>
                                <input type="password" id="studentPassword" class="input-field" placeholder="Enter password">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="studentPhoto"><i class="fas fa-camera" style="margin-right: 6px;"></i>Student Photo</label>
                            <input type="file" id="studentPhoto" class="input-field" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-user-check" style="margin-right: 8px;"></i>
                            <span class="btn-text">Register Student</span>
                        </button>
                        <div class="status-message" id="registerStatus"></div>
                    </form>
                </div>

                <!-- Deregister Student -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-user-minus"></i></div>Deregister Student</h3>
                        <p>Remove a student from the system</p>
                    </div>
                    <form id="deregisterStudentForm">
                        <div class="form-group">
                            <label for="deregStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="deregStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-user-times" style="margin-right: 8px;"></i>
                            <span class="btn-text">Deregister Student</span>
                        </button>
                        <div class="status-message" id="deregisterStatus"></div>
                    </form>
                </div>

                <!-- Grant Academic Leave -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-calendar-times"></i></div>Grant Academic Leave</h3>
                        <p>Grant academic leave to a student</p>
                    </div>
                    <form id="grantLeaveForm">
                        <div class="form-group">
                            <label for="leaveStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="leaveStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveStartDate"><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>Start Date</label>
                                <input type="date" id="leaveStartDate" class="input-field" required>
                            </div>
                            <div class="form-group">
                                <label for="leaveEndDate"><i class="fas fa-calendar-check" style="margin-right: 6px;"></i>End Date</label>
                                <input type="date" id="leaveEndDate" class="input-field" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leaveReason"><i class="fas fa-comment" style="margin-right: 6px;"></i>Reason</label>
                            <textarea id="leaveReason" class="input-field" placeholder="Enter reason for academic leave" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            <span class="btn-text">Grant Leave</span>
                        </button>
                        <div class="status-message" id="grantLeaveStatus"></div>
                    </form>
                </div>

                <!-- Register Units for Student -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-book-open"></i></div>Register Units</h3>
                        <p>Register course units for a student</p>
                    </div>
                    <form id="registerUnitsForm">
                        <div class="form-group">
                            <label for="unitStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="unitStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="unitName"><i class="fas fa-book" style="margin-right: 6px;"></i>Unit Name</label>
                                <input type="text" id="unitName" class="input-field" placeholder="Enter unit name" required>
                            </div>
                            <div class="form-group">
                                <label for="unitCode"><i class="fas fa-hashtag" style="margin-right: 6px;"></i>Unit Code</label>
                                <input type="text" id="unitCode" class="input-field" placeholder="Enter unit code" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>
                            <span class="btn-text">Register Unit</span>
                        </button>
                        <div class="status-message" id="unitStatus"></div>
                    </form>
                </div>

                <!-- Promote Student -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-arrow-up"></i></div>Promote Student</h3>
                        <p>Promote student to next level</p>
                    </div>
                    <form id="promoteStudentForm">
                        <div class="form-group">
                            <label for="promoteStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="promoteStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-group">
                            <label for="newYearSemester"><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>New Year/Semester</label>
                            <input type="text" id="newYearSemester" class="input-field" placeholder="e.g., Year 3 Semester 1" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-level-up-alt" style="margin-right: 8px;"></i>
                            <span class="btn-text">Promote Student</span>
                        </button>
                        <div class="status-message" id="promoteStatus"></div>
                    </form>
                </div>

                <!-- Re-admit Student -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-user-check"></i></div>Re-admit Student</h3>
                        <p>Re-admit a student from academic leave</p>
                    </div>
                    <form id="readmitStudentForm">
                        <div class="form-group">
                            <label for="readmitStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="readmitStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-undo" style="margin-right: 8px;"></i>
                            <span class="btn-text">Re-admit Student</span>
                        </button>
                        <div class="status-message" id="readmitStatus"></div>
                    </form>
                </div>

                <!-- Upload Exam Card -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-id-card"></i></div>Upload Exam Card</h3>
                        <p>Upload exam card for a student</p>
                    </div>
                    <form id="examCardForm">
                        <div class="form-group">
                            <label for="examCardStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="examCardStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-group">
                            <label for="examCardFile"><i class="fas fa-file-pdf" style="margin-right: 6px;"></i>Exam Card File (PDF only)</label>
                            <input type="file" id="examCardFile" class="input-field" accept=".pdf,application/pdf" required>
                            <div class="file-preview" id="examCardPreview"></div>
                            <div class="file-info" id="examCardFileInfo"></div>
                            <p class="form-help-text">Only PDF files are accepted</p>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            <span class="btn-text">Upload Exam Card</span>
                        </button>
                        <div class="status-message" id="examCardStatus"></div>
                    </form>
                </div>

                <!-- Manage Fees -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>Manage Fees</h3>
                        <p>Update student fee information</p>
                    </div>
                    <form id="feesForm">
                        <div class="form-group">
                            <label for="feesStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="feesStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="semesterFee"><i class="fas fa-dollar-sign" style="margin-right: 6px;"></i>Semester Fee</label>
                                <input type="number" id="semesterFee" class="input-field" placeholder="Enter semester fee" required>
                            </div>
                            <div class="form-group">
                                <label for="feeBalance"><i class="fas fa-balance-scale" style="margin-right: 6px;"></i>Fee Balance</label>
                                <input type="number" id="feeBalance" class="input-field" placeholder="Enter fee balance" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="totalPaid"><i class="fas fa-check-circle" style="margin-right: 6px;"></i>Total Paid</label>
                            <input type="number" id="totalPaid" class="input-field" placeholder="Enter total paid" required>
                        </div>
                        <div class="form-group">
                            <label for="feesStatementFile"><i class="fas fa-file-pdf" style="margin-right: 6px;"></i>Fees Statement (PDF only) - Optional</label>
                            <input type="file" id="feesStatementFile" class="input-field" accept=".pdf,application/pdf">
                            <div class="file-preview" id="feesStatementPreview"></div>
                            <div class="file-info" id="feesStatementFileInfo"></div>
                            <p class="form-help-text">Upload fees statement in PDF format (optional)</p>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>
                            <span class="btn-text">Update Fees</span>
                        </button>
                        <div class="status-message" id="feesStatus"></div>
                    </form>
                </div>

                <!-- Upload Finance Document -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-file-invoice-dollar"></i></div>Finance Document</h3>
                        <p>Upload financial statement or receipt</p>
                    </div>
                    <form id="financeForm">
                        <div class="form-group">
                            <label for="financeStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="financeStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-group">
                            <label for="documentType"><i class="fas fa-file-alt" style="margin-right: 6px;"></i>Document Type</label>
                            <select id="documentType" class="input-field" required>
                                <option value="statement">Statement</option>
                                <option value="receipt">Receipt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="financeFile"><i class="fas fa-file-pdf" style="margin-right: 6px;"></i>Document File (PDF only)</label>
                            <input type="file" id="financeFile" class="input-field" accept=".pdf,application/pdf" required>
                            <div class="file-preview" id="financePreview"></div>
                            <div class="file-info" id="financeFileInfo"></div>
                            <p class="form-help-text">Only PDF files are accepted</p>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            <span class="btn-text">Upload Document</span>
                        </button>
                        <div class="status-message" id="financeStatus"></div>
                    </form>
                </div>

                <!-- View Students -->
                <div class="card" id="viewStudentsCard">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-users"></i></div>View Students</h3>
                        <p>Browse and manage all registered students</p>
                    </div>
                    <div class="card-content">
                        <div class="search-filter-container">
                            <div class="search-box">
                                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                                <input type="text" id="studentSearch" class="input-field" style="padding-left: 40px;" placeholder="Search by name or registration number" oninput="searchStudents(this.value)">
                            </div>
                            <div class="filter-controls">
                                <select id="statusFilter" class="input-field" onchange="filterStudents()" style="width: 150px;">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="on-leave">On Leave</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                                <button class="btn btn-outline" onclick="fetchStudents()" title="Refresh Students">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div id="studentsTableContainer" class="students-table-container">
                            <!-- Table will be rendered here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Upload Results -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-chart-bar"></i></div>Upload Results</h3>
                        <p>Upload semester results for a student</p>
                    </div>
                    <form id="resultsForm">
                        <div class="form-group">
                            <label for="resultsStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="resultsStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-group">
                            <label for="resultsSemester"><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>Semester</label>
                            <select id="resultsSemester" class="input-field" required>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resultsFile"><i class="fas fa-file-pdf" style="margin-right: 6px;"></i>Results File (PDF only)</label>
                            <input type="file" id="resultsFile" class="input-field" accept=".pdf,application/pdf" required>
                            <div class="file-preview" id="resultsPreview"></div>
                            <div class="file-info" id="resultsFileInfo"></div>
                            <p class="form-help-text">Upload results slip in PDF format</p>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            <span class="btn-text">Upload Results</span>
                        </button>
                        <div class="status-message" id="resultsStatus"></div>
                    </form>
                </div>

                <!-- Upload Timetable -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-calendar-week"></i></div>Upload Timetable</h3>
                        <p>Upload semester timetable for a student</p>
                    </div>
                    <form id="timetableForm">
                        <div class="form-group">
                            <label for="timetableStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Registration Number</label>
                            <input type="text" id="timetableStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableSemester"><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>Semester</label>
                            <select id="timetableSemester" class="input-field" required>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timetableFile"><i class="fas fa-file-pdf" style="margin-right: 6px;"></i>Timetable File (PDF only)</label>
                            <input type="file" id="timetableFile" class="input-field" accept=".pdf,application/pdf" required>
                            <div class="file-preview" id="timetablePreview"></div>
                            <div class="file-info" id="timetableFileInfo"></div>
                            <p class="form-help-text">Upload timetable in PDF format</p>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            <span class="btn-text">Upload Timetable</span>
                        </button>
                        <div class="status-message" id="timetableStatus"></div>
                    </form>
                </div>

                <!-- Unit Management -->                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-book"></i></div>Create Unit</h3>
                        <p>Create a new course unit</p>
                    </div>
                    <form id="createUnitForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="createUnitName"><i class="fas fa-book" style="margin-right: 6px;"></i>Unit Name</label>
                                <input type="text" id="createUnitName" class="input-field" placeholder="Enter unit name" required>
                            </div>
                            <div class="form-group">
                                <label for="createUnitCode"><i class="fas fa-hashtag" style="margin-right: 6px;"></i>Unit Code</label>
                                <input type="text" id="createUnitCode" class="input-field" placeholder="Enter unit code" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>
                            <span class="btn-text">Create Unit</span>
                        </button>
                        <div class="status-message" id="createUnitStatus"></div>
                    </form>
                </div>

                <!-- Allocate Units to Student -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-user-graduate"></i></div>Allocate Units</h3>
                        <p>Allocate course units to a student</p>
                    </div>
                    <form id="allocateUnitsForm">
                        <div class="form-group">
                            <label for="allocateStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Student Registration Number</label>
                            <input type="text" id="allocateStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="allocateSemester"><i class="fas fa-calendar-alt" style="margin-right: 6px;"></i>Semester</label>
                                <select id="allocateSemester" class="input-field" required>
                                    <option value="">Select Semester</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="allocateAcademicYear"><i class="fas fa-graduation-cap" style="margin-right: 6px;"></i>Academic Year</label>
                                <input type="text" id="allocateAcademicYear" class="input-field" placeholder="e.g., 2024/2025" value="2024/2025" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="unitsToAllocate"><i class="fas fa-list" style="margin-right: 6px;"></i>Select Units to Allocate</label>
                            <div class="units-section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Available course units:</span>
                                <button type="button" class="btn btn-outline" onclick="loadAvailableUnits()" style="padding: 6px 12px; font-size: 0.85rem;">
                                    <i class="fas fa-sync-alt"></i> Refresh Units
                                </button>
                            </div>
                            <div id="unitsToAllocate" class="units-selection">
                                <div class="loading-message">Loading available units...</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="allocationNotes"><i class="fas fa-sticky-note" style="margin-right: 6px;"></i>Notes (Optional)</label>
                            <textarea id="allocationNotes" class="input-field" rows="3" placeholder="Add any notes about this allocation"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            <span class="btn-text">Allocate Units</span>
                        </button>
                        <div class="status-message" id="allocateUnitsStatus"></div>
                    </form>
                </div>

                <!-- View Student Allocations -->
                <div class="card">
                    <div class="card-header">
                        <h3><div class="card-icon"><i class="fas fa-list-alt"></i></div>View Allocations</h3>
                        <p>View unit allocations for a student</p>
                    </div>
                    <form id="viewAllocationsForm">
                        <div class="form-group">
                            <label for="viewAllocationsStudentReg"><i class="fas fa-id-card" style="margin-right: 6px;"></i>Student Registration Number</label>
                            <input type="text" id="viewAllocationsStudentReg" class="input-field" placeholder="Enter registration number" required>
                        </div>
                        <button type="submit" class="btn btn-secondary btn-full">
                            <i class="fas fa-search" style="margin-right: 8px;"></i>
                            <span class="btn-text">View Allocations</span>
                        </button>
                        <div class="status-message" id="viewAllocationsStatus"></div>
                    </form>
                    <div id="allocationsDisplay" class="allocations-display" style="display: none;">
                        <h4>Allocated Units</h4>
                        <div id="allocationsTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Constants - Unified API configuration for all environments
        const getApiBaseUrl = () => {
            // Use the same production URL for both development and production
            return 'https://clipscollegebackend.vercel.app';
        };
        
        const API_BASE_URL = getApiBaseUrl();
        const ADMIN_TOKEN_KEY = 'adminToken';
        const ADMIN_DATA_KEY = 'adminData';
        
        // Log the current API URL for debugging
        console.log('Using API Base URL:', API_BASE_URL);

        // Utility functions
        const showElement = (element) => element.style.display = 'block';
        const hideElement = (element) => element.style.display = 'none';
        const $ = (id) => document.getElementById(id);

        // Student data management
        let studentsData = [];
        let currentPage = 1;
        const pageSize = 10;
        let sortField = 'name';
        let sortDirection = 'asc';
        
        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Icons based on notification type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle" style="color: var(--success-color); font-size: 1.2rem; margin-right: 10px;"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle" style="color: var(--error-color); font-size: 1.2rem; margin-right: 10px;"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color); font-size: 1.2rem; margin-right: 10px;"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle" style="color: var(--secondary-color); font-size: 1.2rem; margin-right: 10px;"></i>';
            }
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center;">
                    ${icon}
                    <div style="font-weight: 600; font-size: 1rem;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div style="margin-left: auto; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times" style="color: #888; font-size: 0.9rem;"></i>
                    </div>
                </div>
                <div style="margin-top: 8px; margin-left: 32px; font-size: 0.95rem; line-height: 1.5;">${message}</div>
            `;
            
            $('toastContainer').appendChild(toast);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => toast.remove(), 400);
            }, 5000);
        }

        // Status message helper
        function showStatus(elementId, message, type = 'success') {
            const statusEl = $(elementId);
            
            // Add appropriate icon based on type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle" style="margin-right: 8px;"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-times-circle" style="margin-right: 8px;"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>';
                    break;
            }
            
            statusEl.innerHTML = icon + message;
            statusEl.className = `status-message ${type}`;
            showElement(statusEl);
            
            // Animate and hide after 5 seconds
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => hideElement(statusEl), 500);
            }, 5000);
        }

        // Loading state management
        function setLoadingState(buttonId, isLoading, text = '') {
            const btn = $(buttonId);
            if (!btn) return;
            
            const btnText = btn.querySelector('.btn-text') || btn.querySelector('span');
            const icon = btn.querySelector('i:not(.spinner)');
            
            if (isLoading) {
                btn.disabled = true;
                if (icon) icon.style.display = 'none';
                if (btnText) {
                    btnText.innerHTML = '<div class="spinner"></div><span style="margin-left: 5px;">Processing...</span>';
                } else {
                    btn.innerHTML = '<div class="spinner"></div><span style="margin-left: 5px;">Processing...</span>';
                }
                btn.classList.add('processing');
                btn.style.opacity = '0.85';
            } else {
                btn.disabled = false;
                if (icon) icon.style.display = 'inline-block';
                if (btnText) {
                    btnText.textContent = text || btnText.textContent.replace('Processing...', '').trim();
                } else if (text) {
                    btn.textContent = text;
                }
                btn.classList.remove('processing');
                btn.style.opacity = '1';
            }
        }

        // Debug logging utility
        function debugLog(message, data) {
            const DEBUG = true; // Set to false in production
            if (DEBUG) {
                console.log(`%c${message}`, 'color: #0066ff; font-weight: bold;', data);
            }
        }

        // API request helper with better error handling
        async function apiRequest(url, options = {}) {
            try {
                debugLog(`API Request to ${url}`, { method: options.method || 'GET' });
                
                const token = localStorage.getItem(ADMIN_TOKEN_KEY);
                const isFormData = options.body instanceof FormData;
                const isBinaryFile = options.body instanceof File;
                
                // Clone the options to avoid modifying the original
                const fetchOptions = { ...options };
                
                // Initialize headers - be careful with FormData
                if (isFormData) {
                    // For FormData, start with empty headers and only add auth
                    fetchOptions.headers = {};
                } else {
                    // For other requests, preserve existing headers
                    fetchOptions.headers = { ...options.headers } || {};
                }
                
                // Add authorization token if available
                if (token) {
                    fetchOptions.headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Handle different upload types
                if (isFormData) {
                    // For FormData, DO NOT set Content-Type header - let the browser handle it with the proper boundary
                    // Accept JSON responses
                    fetchOptions.headers['Accept'] = 'application/json';
                    
                    debugLog(`Sending FormData to ${url}`, {
                        fields: [...options.body.keys()],
                        method: options.method || 'GET',
                        fileFields: [...options.body.keys()].filter(key => {
                            const value = options.body.get(key);
                            return value instanceof File || value instanceof Blob;
                        }).map(key => ({
                            key,
                            fileName: options.body.get(key).name,
                            fileType: options.body.get(key).type,
                            fileSize: options.body.get(key).size
                        }))
                    });
                } else if (isBinaryFile) {
                    // For binary file uploads, keep the Content-Type set by the caller
                    // Accept JSON responses
                    fetchOptions.headers['Accept'] = 'application/json';
                    
                    debugLog(`Sending binary file to ${url}`, {
                        fileName: options.body.name,
                        fileType: options.body.type,
                        fileSize: `${(options.body.size / 1024).toFixed(2)} KB`,
                        method: options.method || 'GET',
                        contentType: fetchOptions.headers['Content-Type']
                    });
                } else {
                    // For non-file requests, set standard headers
                    fetchOptions.headers['Accept'] = 'application/json';
                    if (!fetchOptions.headers['Content-Type']) {
                        fetchOptions.headers['Content-Type'] = 'application/json';
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}${url}`, fetchOptions);

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                let data;
                
                debugLog(`API Response status: ${response.status}`, { 
                    contentType,
                    url,
                    method: options.method || 'GET'
                });
                
                try {
                    // Try JSON first if content type suggests JSON
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                        debugLog('API Response data (JSON):', data);
                    } else {
                        // If not JSON, get text
                        const text = await response.text();
                        debugLog('API Response text:', text);
                        
                        // Try to parse as JSON anyway in case Content-Type is wrong
                        if (text && text.trim() && (text.startsWith('{') || text.startsWith('['))) {
                            try {
                                data = JSON.parse(text);
                                debugLog('Parsed text response as JSON:', data);
                            } catch (parseError) {
                                // Not valid JSON after all
                                data = { error: text || `HTTP ${response.status}: ${response.statusText}` };
                            }
                        } else {
                            // Plain text response
                            data = { error: text || `HTTP ${response.status}: ${response.statusText}` };
                        }
                    }
                } catch (parseError) {
                    debugLog('Error parsing response:', parseError.message);
                    data = { 
                        error: `Failed to parse server response: ${parseError.message}`,
                        status: response.status
                    };
                }
                
                if (!response.ok) {
                    // Check if the error is in a structured format
                    if (data && data.error) {
                        let errorMessage = data.error;
                        // If there are details, append them
                        if (data.details) {
                            errorMessage += `: ${data.details}`;
                        }
                        // If there's help text, log it
                        if (data.help) {
                            console.log(`API Error Help: ${data.help}`);
                            debugLog('API Error Help:', data.help);
                        }
                        
                        // Special handling for form data errors
                        if (errorMessage.includes('FormData') && options.body instanceof FormData) {
                            console.log('FormData parsing error details:', new Error(errorMessage));
                            debugLog('FormData contents:', {
                                fieldCount: [...options.body.keys()].length,
                                fields: [...options.body.keys()],
                                hasFiles: [...options.body.values()].some(v => v instanceof File)
                            });
                        }
                        
                        throw new Error(errorMessage);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}. ${data ? JSON.stringify(data) : ''}`);
                    }
                }

                return { success: true, data };
            } catch (error) {
                console.error('API Request failed:', error);
                
                // Enhanced error handling with more specific messages
                let errorMessage = error.message;
                
                if (error.message.includes('FormData')) {
                    console.log('FormData parsing error details:', error);
                    errorMessage = 'Error with file upload format. Please try again with a different file or contact support.';
                } else if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    // This often indicates CORS issues in production
                    console.error('Network/CORS error details:', { 
                        apiUrl: API_BASE_URL, 
                        currentUrl: window.location.origin,
                        error: error.message 
                    });
                    
                    if (API_BASE_URL.includes('localhost') && !window.location.hostname.includes('localhost')) {
                        errorMessage = 'Configuration error: Cannot connect to localhost from production. Please check the API configuration.';
                    } else if (window.location.protocol === 'https:' && API_BASE_URL.startsWith('http:')) {
                        errorMessage = 'Security error: Cannot make HTTP requests from HTTPS site. The API must use HTTPS.';
                    } else {
                        errorMessage = 'Network error. Please check your connection and ensure the server is running.';
                    }
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server error. The operation could not be completed. The server team has been notified.';
                } else if (error.message.includes('400') && options.body instanceof FormData) {
                    errorMessage = 'Error with file upload. The server could not process your file.';
                    console.log('Form data upload error:', error);
                } else if (error.message.includes('404')) {
                    errorMessage = 'Resource not found. Please check the URL and try again.';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Authentication error. Please log in again.';
                    // If authentication error, clear token
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'Cross-origin request blocked. Please contact support to resolve server configuration.';
                }
                
                return { 
                    success: false, 
                    error: errorMessage,
                    originalError: error.message
                };
            }
        }        // Connection test function for debugging production issues
        async function testApiConnection() {
            debugLog('Testing API connection...', { url: API_BASE_URL });
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    debugLog('API connection successful', data);
                    showToast('API connection successful', 'success');
                    return true;
                } else {
                    debugLog('API connection failed', { status: response.status, statusText: response.statusText });
                    showToast(`API connection failed: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                debugLog('API connection error', error);
                showToast(`API connection error: ${error.message}`, 'error');
                
                // Provide specific guidance based on error type
                if (error.message.includes('Failed to fetch')) {
                    console.error('Possible CORS or network connectivity issue. Check:');
                    console.error('1. Is the backend server running?');
                    console.error('2. Are CORS headers properly configured on the backend?');
                    console.error('3. Is the API URL correct?', API_BASE_URL);
                    console.error('4. If using HTTPS frontend, ensure backend also uses HTTPS');
                }
                
                return false;
            }
        }

        // Student management functions
        async function fetchStudents() {
            // Show loading state
            const tableContainer = $('studentsTableContainer');
            if (tableContainer) {
                tableContainer.innerHTML = `
                <div class="table-loading">
                    <div class="spinner" style="width: 30px; height: 30px;"></div>
                    <div>Loading students...</div>
                </div>`;
            }
            
            try {
                // Use apiRequest helper instead of direct fetch to ensure consistent error handling
                const result = await apiRequest('/students');
                
                if (result.success) {
                    // Check if the response is an array or has a data property
                    const data = Array.isArray(result.data) ? result.data : 
                             (result.data.students || result.data);
                    
                    if (Array.isArray(data)) {
                        // Map status field since it's not in the API response
                        studentsData = data.map(student => ({
                            ...student,
                            status: student.status || 'active' // Use existing status or default to active
                        }));
                        showToast(`${studentsData.length} students loaded successfully`, 'success');
                    } else {
                        console.warn('Unexpected data format:', result.data);
                        studentsData = getSampleStudentData();
                        showToast('Unable to parse student data, using sample data instead', 'warning');
                    }
                } else {
                    // If API request fails, use sample data for demonstration
                    console.warn('API request failed:', result.error);
                    studentsData = getSampleStudentData();
                    showToast('Using sample data for demonstration', 'info');
                }
            } catch (error) {
                console.error('Error fetching students:', error);
                // Use sample data as fallback
                studentsData = getSampleStudentData();
                showToast('Using sample data for demonstration', 'info');
            }
            
            // Initially sort by name
            sortStudents('name');
            // Reset filters
            if ($('studentSearch')) $('studentSearch').value = '';
            if ($('statusFilter')) $('statusFilter').value = 'all';
        }
        
        // Update student status in local data
        function updateStudentStatus(registrationNumber, newStatus) {
            const studentIndex = studentsData.findIndex(s => s.registration_number === registrationNumber);
            if (studentIndex !== -1) {
                studentsData[studentIndex].status = newStatus;
                // Re-render the table to reflect the status change
                renderStudentsTable();
                debugLog(`Updated student status locally`, {
                    registration_number: registrationNumber,
                    new_status: newStatus
                });
            } else {
                debugLog(`Student not found for status update`, {
                    registration_number: registrationNumber,
                    new_status: newStatus
                });
            }
        }
        
        
        
        // Search students by name or registration number
        function searchStudents(query) {
            if (!query.trim()) {
                // If search is cleared, reset to showing all students with current filter
                filterStudents();
                return;
            }
            
            const statusFilter = $('statusFilter').value;
            query = query.toLowerCase().trim();
            
            const filtered = studentsData.filter(student => {
                const matchesSearch = (student.name && student.name.toLowerCase().includes(query)) || 
                                     (student.registration_number && student.registration_number.toLowerCase().includes(query));
                                     
                const matchesStatus = statusFilter === 'all' || student.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            renderFilteredStudents(filtered);
        }
        
        // Filter students by status
        function filterStudents() {
            const statusFilter = $('statusFilter').value;
            const searchQuery = $('studentSearch').value.toLowerCase().trim();
            
            if (statusFilter === 'all' && !searchQuery) {
                // If no filters applied, show all students
                currentPage = 1;
                renderStudentsTable();
                return;
            }
            
            const filtered = studentsData.filter(student => {
                const matchesStatus = statusFilter === 'all' || student.status === statusFilter;
                const matchesSearch = !searchQuery || 
                                     (student.name && student.name.toLowerCase().includes(searchQuery)) || 
                                     (student.registration_number && student.registration_number.toLowerCase().includes(searchQuery));
                
                return matchesStatus && matchesSearch;
            });
            
            renderFilteredStudents(filtered);
        }
        
        // Render filtered students results
        function renderFilteredStudents(filteredData) {
            const tableContainer = $('studentsTableContainer');
            if (!tableContainer) return;
            
            if (!filteredData.length) {
                tableContainer.innerHTML = `
                <div class="table-empty">
                    <i class="fas fa-search" style="font-size: 40px; color: var(--text-secondary); margin-bottom: 15px;"></i>
                    <h3>No Matching Students</h3>
                    <p>No students match your search criteria. Try adjusting your filters.</p>
                </div>`;
                return;
            }
            
            // Store current sort settings
            const currentSortField = sortField;
            const currentSortDirection = sortDirection;
            
            // Temporarily replace students data with filtered results
            const originalData = studentsData;
            studentsData = filteredData;
            
            // Reset to page 1 for new filter/search
            currentPage = 1;
            
            // Sort filtered data with current sort settings
            sortField = currentSortField;
            sortDirection = currentSortDirection;
            sortStudents(sortField);
            
            // Restore original data
            studentsData = originalData;
        }

        // Sort students data
        function sortStudents(field) {
            if (sortField === field) {
                // Toggle direction if clicking the same field
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // Default to ascending for a new sort field
                sortField = field;
                sortDirection = 'asc';
            }
            
            studentsData.sort((a, b) => {
                // Handle cases where field might be undefined
                const aVal = a[field] !== undefined ? a[field] : '';
                const bVal = b[field] !== undefined ? b[field] : '';
                
                // Case insensitive string comparison
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return sortDirection === 'asc' 
                        ? aVal.localeCompare(bVal) 
                        : bVal.localeCompare(aVal);
                }
                
                // Number comparison
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            renderStudentsTable();
        }

        // Handle pagination
        function handlePagination(newPage) {
            currentPage = newPage;
            renderStudentsTable();
            // Scroll to top of table
            $('viewStudentsCard').scrollIntoView({ behavior: 'smooth' });
        }        // Render students table with current data, sorting, and pagination
        function renderStudentsTable() {
            const tableContainer = $('studentsTableContainer');
            if (!tableContainer) return;
            
            if (!studentsData.length) {
                tableContainer.innerHTML = `
                <div class="table-empty">
                    <i class="fas fa-users-slash" style="font-size: 40px; color: var(--text-secondary); margin-bottom: 15px;"></i>
                    <h3>No Students Found</h3>
                    <p>There are currently no students registered in the system.</p>
                </div>`;
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(studentsData.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, studentsData.length);
            const currentStudents = studentsData.slice(startIndex, endIndex);
            
            // Generate table HTML
            let tableHTML = `
            <div class="table-wrapper">
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th class="sortable ${sortField === 'name' ? 'sorted-' + sortDirection : ''}" onclick="sortStudents('name')">
                                Student Name <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable ${sortField === 'registration_number' ? 'sorted-' + sortDirection : ''}" onclick="sortStudents('registration_number')">
                                Reg Number <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable ${sortField === 'course' ? 'sorted-' + sortDirection : ''}" onclick="sortStudents('course')">
                                Course <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable ${sortField === 'level_of_study' ? 'sorted-' + sortDirection : ''}" onclick="sortStudents('level_of_study')">
                                Level of Study <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable ${sortField === 'status' ? 'sorted-' + sortDirection : ''}" onclick="sortStudents('status')">
                                Status <i class="fas fa-sort"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
                    
            currentStudents.forEach(student => {
                // Generate initials for placeholder if no photo
                const nameParts = (student.name || '').split(' ');
                const initials = nameParts.length > 1 
                    ? (nameParts[0][0] + nameParts[1][0]).toUpperCase() 
                    : (nameParts[0] ? nameParts[0][0].toUpperCase() : '?');
                
                // Display national ID or birth certificate in tooltip
                const identificationInfo = student.national_id ? 
                    `National ID: ${student.national_id}` : 
                    student.birth_certificate ? 
                    `Birth Certificate: ${student.birth_certificate}` : '';
                
                // Format date of birth if available
                let dateOfBirth = '';
                if (student.date_of_birth) {
                    const dob = new Date(student.date_of_birth);
                    dateOfBirth = dob.toLocaleDateString('en-US', {
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric'
                    });
                }
                
                // Determine status class - use active as default if no status is provided
                const status = student.status || 'active';
                const statusClass = status === 'active' ? 'active' 
                    : status === 'on-leave' ? 'on-leave' 
                    : 'inactive';
                
                tableHTML += `
                <tr>
                    <td>
                        ${student.photo_url 
                            ? `<img src="${student.photo_url}" alt="${student.name}" class="student-photo">` 
                            : `<div class="student-photo-placeholder" title="${dateOfBirth ? 'DOB: ' + dateOfBirth : ''}">${initials}</div>`
                        }
                    </td>
                    <td title="${identificationInfo}">${student.name || 'N/A'}</td>
                    <td>${student.registration_number || 'N/A'}</td>
                    <td>${student.course || 'N/A'}</td>
                    <td>${student.level_of_study || 'N/A'}</td>
                    <td>
                        <span class="student-status ${statusClass}">${status}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewStudentDetails('${student.registration_number}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn edit" onclick="editStudent('${student.registration_number}')">
                                <i class="fas fa-pen"></i> Edit
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            </div>
            
            <div class="table-pagination">
                <div class="pagination-info">
                    Showing ${startIndex + 1} to ${endIndex} of ${studentsData.length} students
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="handlePagination(1)">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="handlePagination(${currentPage - 1})">
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <span style="margin: 0 10px; color: var(--text-primary);">Page ${currentPage} of ${totalPages}</span>
                    
                    <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="handlePagination(${currentPage + 1})">
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="handlePagination(${totalPages})">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>`;
            
            tableContainer.innerHTML = tableHTML;
        }        // Student detail view function
        function viewStudentDetails(regNumber) {
            // Find the student in the data
            const student = studentsData.find(s => s.registration_number === regNumber);
            
            if (!student) {
                showToast(`Student with registration number ${regNumber} not found.`, 'error');
                return;
            }
            
            // Format the date of birth
            let formattedDOB = 'Not provided';
            if (student.date_of_birth) {
                try {
                    const dob = new Date(student.date_of_birth);
                    if (!isNaN(dob.getTime())) { // Check if date is valid
                        formattedDOB = dob.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                } catch (e) {
                    console.warn('Invalid date format:', student.date_of_birth);
                }
            }
            
            // Generate initials safely
            let initials = '??';
            try {
                if (student.name) {
                    const nameParts = student.name.split(' ');
                    initials = nameParts.length > 1 
                        ? (nameParts[0][0] + nameParts[1][0]).toUpperCase() 
                        : (nameParts[0] ? nameParts[0][0].toUpperCase() : '?');
                }
            } catch (e) {
                console.warn('Error generating initials:', e);
            }
            
            // Create a modal to display student details
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Student Details</h2>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="student-profile">
                            <div class="student-avatar">
                                ${student.photo_url 
                                    ? `<img src="${student.photo_url}" alt="${student.name || 'Student'}" class="large-photo">` 
                                    : `<div class="large-photo-placeholder">${initials}</div>`
                                }
                            </div>
                            <div class="student-info">
                                <h3>${student.name || 'No Name'}</h3>
                                <p class="student-meta"><strong>Registration:</strong> ${student.registration_number || 'N/A'}</p>
                                <p class="student-meta"><strong>Course:</strong> ${student.course || 'Not specified'}</p>
                                <p class="student-meta"><strong>Level:</strong> ${student.level_of_study || 'Not specified'}</p>
                                <span class="student-status ${student.status || 'active'}">${student.status || 'Active'}</span>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h4>Personal Information</h4>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Date of Birth:</span>
                                    <span class="detail-value">${formattedDOB}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">National ID:</span>
                                    <span class="detail-value">${student.national_id || 'Not provided'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Birth Certificate:</span>
                                    <span class="detail-value">${student.birth_certificate || 'Not provided'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Student ID:</span>
                                    <span class="detail-value">${student.id || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="closeModalBtn">Close</button>
                        <button class="btn btn-primary" id="editStudentBtn">
                            <i class="fas fa-edit"></i> Edit Student
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listener to close button using safer approaches
            const closeBtn = modal.querySelector('.modal-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                });
            }
            
            // Add event listeners to buttons using safer approaches
            const closeModalBtn = modal.querySelector('#closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                });
            }
            
            const editStudentBtn = modal.querySelector('#editStudentBtn');
            if (editStudentBtn && student && student.registration_number) {
                editStudentBtn.addEventListener('click', function() {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                    editStudent(student.registration_number);
                });
            }
            
            // Close modal if clicked outside content
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }
            });
        }
          // Edit student function
        function editStudent(regNumber) {
            // Find the student in the data
            const student = studentsData.find(s => s.registration_number === regNumber);
            
            if (!student) {
                showToast(`Student with registration number ${regNumber} not found.`, 'error');
                return;
            }
            
            // Format the date for input field (YYYY-MM-DD)
            let formattedInputDate = '';
            if (student.date_of_birth) {
                try {
                    const dob = new Date(student.date_of_birth);
                    if (!isNaN(dob.getTime())) { // Check if date is valid
                        formattedInputDate = dob.toISOString().split('T')[0];
                    }
                } catch (e) {
                    console.warn('Invalid date format for edit:', student.date_of_birth);
                }
            }
            
            // Safely escape values for HTML
            const safeEscape = (value) => {
                if (value === null || value === undefined) return '';
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };
            
            // Create a modal for editing
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content edit-student-modal">
                    <div class="modal-header">
                        <h2>Edit Student</h2>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editStudentForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editStudentName"><i class="fas fa-user"></i> Full Name</label>
                                    <input type="text" id="editStudentName" class="input-field" value="${safeEscape(student.name)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editStudentReg"><i class="fas fa-id-card"></i> Registration Number</label>
                                    <input type="text" id="editStudentReg" class="input-field" value="${safeEscape(student.registration_number)}" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editStudentCourse"><i class="fas fa-book"></i> Course</label>
                                    <input type="text" id="editStudentCourse" class="input-field" value="${safeEscape(student.course)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editStudentLevel"><i class="fas fa-calendar-alt"></i> Level of Study</label>
                                    <input type="text" id="editStudentLevel" class="input-field" value="${safeEscape(student.level_of_study)}" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editStudentNationalId"><i class="fas fa-id-card"></i> National ID</label>
                                    <input type="text" id="editStudentNationalId" class="input-field" value="${safeEscape(student.national_id)}">
                                </div>
                                <div class="form-group">
                                    <label for="editStudentBirthCert"><i class="fas fa-certificate"></i> Birth Certificate</label>
                                    <input type="text" id="editStudentBirthCert" class="input-field" value="${safeEscape(student.birth_certificate)}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editStudentDob"><i class="fas fa-birthday-cake"></i> Date of Birth</label>
                                    <input type="date" id="editStudentDob" class="input-field" value="${formattedInputDate}">
                                </div>
                                <div class="form-group">
                                    <label for="editStudentStatus"><i class="fas fa-user-check"></i> Status</label>
                                    <select id="editStudentStatus" class="input-field">
                                        <option value="active" ${(student.status === 'active' || !student.status) ? 'selected' : ''}>Active</option>
                                        <option value="on-leave" ${student.status === 'on-leave' ? 'selected' : ''}>On Leave</option>
                                        <option value="inactive" ${student.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editStudentPhoto"><i class="fas fa-camera"></i> Student Photo (Optional)</label>
                                <input type="file" id="editStudentPhoto" class="input-field" accept="image/*">
                                <p class="form-help-text">Leave empty to keep current photo</p>
                                ${student.photo_url ? 
                                    `<div class="current-photo">
                                        <p>Current Photo:</p>
                                        <img src="${safeEscape(student.photo_url)}" alt="Current photo" style="max-width: 100px; margin-top: 8px;">
                                    </div>` : 
                                    '<p class="photo-note">No current photo on file</p>'
                                }
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <div class="status-message" id="editStudentStatus" style="display: none;"></div>
                        <button class="btn btn-outline" id="cancelEditBtn">Cancel</button>
                        <button class="btn btn-primary" id="saveStudentBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners using safer approaches
            const closeBtn = modal.querySelector('.modal-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                });
            }
            
            const cancelBtn = modal.querySelector('#cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                });
            }
            
            const saveBtn = modal.querySelector('#saveStudentBtn');
            if (saveBtn && student && student.id) {
                saveBtn.addEventListener('click', function() {
                    saveStudentChanges(student.id);
                });
            }
            
            // Close modal if clicked outside content
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }
            });
        }
          // Function to save student changes
        async function saveStudentChanges(studentId) {
            try {
                // Safe getElementById with error handling
                const safeGetElementValue = (id) => {
                    const element = document.getElementById(id);
                    return element ? element.value.trim() : '';
                };
                
                const name = safeGetElementValue('editStudentName');
                const regNumber = safeGetElementValue('editStudentReg');
                const course = safeGetElementValue('editStudentCourse');
                const level = safeGetElementValue('editStudentLevel');
                const nationalId = safeGetElementValue('editStudentNationalId');
                const birthCert = safeGetElementValue('editStudentBirthCert');
                const dob = safeGetElementValue('editStudentDob');
                
                // Get status from select element
                let status = 'active';
                const statusElement = document.getElementById('editStudentStatus');
                if (statusElement) {
                    status = statusElement.value;
                }
                
                // Validate required fields
                if (!name || !regNumber || !course || !level) {
                    const statusElement = document.getElementById('editStudentStatus');
                    if (statusElement) {
                        statusElement.textContent = 'Please fill out all required fields';
                        statusElement.className = 'status-message error';
                        statusElement.style.display = 'block';
                    } else {
                        showToast('Please fill out all required fields', 'error');
                    }
                    return;
                }
                
                // Find and update save button state
                const saveBtn = document.getElementById('saveStudentBtn');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    const originalContent = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<div class="spinner"></div> Saving...';
                    
                    try {
                        // Check if there is a photo to upload (optional)
                        const photoInput = document.getElementById('editStudentPhoto');
                        const hasPhoto = photoInput && photoInput.files && photoInput.files.length > 0;
                        
                        let result;
                        
                        if (hasPhoto) {
                            // If there's a photo, use FormData to handle the multipart upload
                            const formData = new FormData();
                            formData.append('name', name);
                            formData.append('registration_number', regNumber);
                            formData.append('course', course);
                            formData.append('level_of_study', level);
                            if (nationalId) formData.append('national_id', nationalId);
                            if (birthCert) formData.append('birth_certificate', birthCert);
                            if (dob) formData.append('date_of_birth', dob);
                            formData.append('status', status);
                            formData.append('photo', photoInput.files[0]);
                            
                            debugLog('Sending update for student with photo:', formData);
                            
                            result = await apiRequest(`/students/${studentId}`, {
                                method: 'PUT',
                                body: formData,
                                // Don't set Content-Type header, browser will set it with boundary for FormData
                            });
                        } else {
                            // If no photo, just send JSON data
                            const payload = {
                                name,
                                registration_number: regNumber,
                                course,
                                level_of_study: level,
                                national_id: nationalId || null,
                                birth_certificate: birthCert || null,
                                date_of_birth: dob || null,
                                status
                            };
                            
                            debugLog('Sending update for student:', payload);
                            
                            result = await apiRequest(`/students/${studentId}`, {
                                method: 'PUT',
                                body: JSON.stringify(payload)
                            });
                        }
                        
                        if (result.success) {
                            // Update student in the local data
                            const index = studentsData.findIndex(s => s.id === studentId);
                            if (index !== -1) {
                                // Create updated student data with possible photo URL from response
                                const updatedStudent = { 
                                    ...studentsData[index],
                                    name,
                                    registration_number: regNumber,
                                    course,
                                    level_of_study: level,
                                    national_id: nationalId || null,
                                    birth_certificate: birthCert || null,
                                    date_of_birth: dob || null,
                                    status
                                };
                                
                                // If response includes photo_url, update it
                                if (result.data && result.data.photo_url) {
                                    updatedStudent.photo_url = result.data.photo_url;
                                }
                                
                                studentsData[index] = updatedStudent;
                            }
                            
                            showToast('Student information updated successfully', 'success');
                            renderStudentsTable();
                            
                            // Find and close the modal safely
                            const modal = document.querySelector('.modal');
                            if (modal && modal.parentNode) {
                                modal.parentNode.removeChild(modal);
                            }
                        } else {
                            const statusElement = document.getElementById('editStudentStatus');
                            if (statusElement) {
                                statusElement.textContent = result.error || 'Failed to update student information';
                                statusElement.className = 'status-message error';
                                statusElement.style.display = 'block';
                            } else {
                                showToast(result.error || 'Failed to update student information', 'error');
                            }
                        }
                    } finally {
                        // Restore button state
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalContent || '<i class="fas fa-save"></i> Save Changes';
                        }
                    }
                } else {
                    showToast('Cannot find save button element', 'error');
                }
            } catch (error) {
                console.error('Error in saveStudentChanges:', error);
                showToast('An unexpected error occurred. Please try again.', 'error');
            }        }

        // Display allocated units in the allocations table
        function displayAllocatedUnits(data) {
            const allocationsDisplay = $('allocationsDisplay');
            const allocationsTable = $('allocationsTable');
            
            if (!allocationsDisplay || !allocationsTable) {
                console.error('Allocations display elements not found');
                return;
            }
            
            if (!data.allocated_units || data.allocated_units.length === 0) {
                allocationsTable.innerHTML = `
                    <div class="table-empty">
                        <i class="fas fa-info-circle"></i>
                        <p>No units have been allocated to this student yet.</p>
                    </div>
                `;
            } else {
                // Build table HTML
                let tableHTML = `
                    <div class="table-wrapper">
                        <table class="students-table">
                            <thead>
                                <tr>
                                    <th>Unit Code</th>
                                    <th>Unit Name</th>
                                    <th>Semester</th>
                                    <th>Academic Year</th>
                                    <th>Status</th>
                                    <th>Allocated Date</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.allocated_units.forEach(unit => {
                    const statusClass = unit.status === 'allocated' ? 'status-active' : 
                                       unit.status === 'registered' ? 'status-completed' :
                                       unit.status === 'cancelled' ? 'status-inactive' : 'status-pending';
                    
                    const allocatedDate = unit.allocated_at ? 
                        new Date(unit.allocated_at).toLocaleDateString() : 
                        'N/A';
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${unit.unit_code}</strong></td>
                            <td>${unit.unit_name}</td>
                            <td>Semester ${unit.semester}</td>
                            <td>${unit.academic_year}</td>
                            <td><span class="status-badge ${statusClass}">${unit.status}</span></td>
                            <td>${allocatedDate}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                allocationsTable.innerHTML = tableHTML;
            }
            
            // Show the allocations display
            allocationsDisplay.style.display = 'block';
        }

        // Authentication functions
        async function adminLogin(event) {
            event.preventDefault();
            
            const username = $('adminUsername').value.trim();
            const password = $('adminPassword').value;
            
            console.log('Login attempt with:', { username, password: password ? '[HIDDEN]' : '[EMPTY]' });
            
            if (!username || !password) {
                showStatus('loginStatus', 'Please enter both username and password', 'error');
                return;
            }
            
            setLoadingState('loginBtn', true);
            
            const result = await apiRequest('/auth/admin-login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            console.log('Login result:', { success: result.success, hasData: !!result.data, hasToken: !!(result.data && result.data.token) });

            setLoadingState('loginBtn', false, 'Sign In');            if (result.success && result.data.token) {
                console.log('Login successful, storing token and redirecting');
                localStorage.setItem(ADMIN_TOKEN_KEY, result.data.token);
                localStorage.setItem(ADMIN_DATA_KEY, JSON.stringify({
                    username: result.data.username,
                    id: result.data.adminId || 'unknown'
                }));
                showDashboard();
                showToast('Login successful! Welcome back.');
            } else {
                console.log('Login failed:', result.error);
                showStatus('loginStatus', result.error || 'Login failed. Please check your credentials.', 'error');
            }
        }

        function logout() {
            localStorage.removeItem(ADMIN_TOKEN_KEY);
            localStorage.removeItem(ADMIN_DATA_KEY);
            showLogin();
            showToast('Logged out successfully', 'success');
        }

        // View management
        function showDashboard() {
            hideElement($('loginSection'));
            showElement($('dashboardSection'));
            
            // Load admin data if available
            const adminData = JSON.parse(localStorage.getItem(ADMIN_DATA_KEY) || '{}');
            if (adminData.username) {
                $('adminName').textContent = adminData.username;
            }
            
            // Update debug panel information
            updateDebugPanel();
            
            // Fetch students data when dashboard is shown
            fetchStudents();
        }
        
        // Update debug panel with current environment information
        function updateDebugPanel() {
            const envStatusEl = $('envStatus');
            const apiUrlEl = $('apiUrlDisplay');
            const protocolStatusEl = $('protocolStatus');
            
            if (envStatusEl) {
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                envStatusEl.textContent = isLocal ? 'Development' : 'Production';
                envStatusEl.style.background = isLocal ? '#e3f2fd' : '#fff3e0';
                envStatusEl.style.color = isLocal ? '#1976d2' : '#f57c00';
            }
            
            if (apiUrlEl) {
                apiUrlEl.textContent = API_BASE_URL;
            }
            
            if (protocolStatusEl) {
                const isHttps = window.location.protocol === 'https:';
                const apiIsHttps = API_BASE_URL.startsWith('https:');
                
                if (isHttps && !apiIsHttps) {
                    protocolStatusEl.textContent = 'Mixed Content Issue';
                    protocolStatusEl.style.background = '#ffebee';
                    protocolStatusEl.style.color = '#d32f2f';
                } else if (isHttps && apiIsHttps) {
                    protocolStatusEl.textContent = 'Secure (HTTPS)';
                    protocolStatusEl.style.background = '#e8f5e8';
                    protocolStatusEl.style.color = '#2e7d32';
                } else {
                    protocolStatusEl.textContent = 'HTTP';
                    protocolStatusEl.style.background = '#f3e5f5';
                    protocolStatusEl.style.color = '#7b1fa2';
                }
            }
        }

        function showLogin() {
            showElement($('loginSection'));
            hideElement($('dashboardSection'));
            // Clear form
            $('loginForm').reset();
        }

        // Student data functions
        async function loadStudentsData(page = 1, size = pageSize, sort = sortField, direction = sortDirection) {
            const result = await apiRequest(`/students?page=${page}&size=${size}&sort=${sort},${direction}`);
            
            if (result.success) {
                studentsData = result.data.items;
                currentPage = result.data.currentPage;
                renderStudentsTable();
            } else {
                showToast(result.error, 'error');
            }
        }

        // Form submission handlers
        async function handleFormSubmission(formId, url, method = 'POST', successMessage = 'Operation completed successfully') {
            debugLog(`Starting form submission for: ${formId}`, { formId, url, method });
            
            const form = $(formId);
            
            // Check if form exists
            if (!form) {
                console.error(`Form with ID '${formId}' not found`);
                showToast(`Form not found: ${formId}`, 'error');
                return;
            }
            
            const formData = {};
              // Get form data
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                formData[input.id] = input.value.trim();
            });
            
            // Get select element values
            const selects = form.querySelectorAll('select');
            selects.forEach(select => {
                formData[select.id] = select.value.trim();
            });
            
            // Transform data based on form type
            let payload = {};
            let isFileUpload = false;
            
            switch(formId) {
                case 'registerStudentForm':
                    isFileUpload = $('studentPhoto').files.length > 0;
                    
                    if (isFileUpload) {
                        const studentFormData = new FormData();
                        studentFormData.append('name', formData.studentName);
                        studentFormData.append('registration_number', formData.studentReg);
                        studentFormData.append('course', formData.studentCourse);
                        studentFormData.append('level_of_study', formData.studentYearSemester);
                        studentFormData.append('national_id', formData.studentNationalId || '');
                        studentFormData.append('birth_certificate', formData.studentBirthCert || '');
                        studentFormData.append('date_of_birth', formData.studentDob || '');
                        studentFormData.append('password', formData.studentPassword || '');
                        studentFormData.append('photo', $('studentPhoto').files[0]);
                        payload = studentFormData;
                    } else {
                        payload = {
                            name: formData.studentName,
                            registration_number: formData.studentReg,
                            course: formData.studentCourse,
                            level_of_study: formData.studentYearSemester,
                            national_id: formData.studentNationalId || null,
                            birth_certificate: formData.studentBirthCert || null,
                            date_of_birth: formData.studentDob || null,
                            password: formData.studentPassword || null
                        };
                    }
                    break;
                case 'deregisterStudentForm':
                    payload = {};
                    url = `/students/registration/${formData.deregStudentReg}/deregister`;
                    break;
                case 'registerUnitsForm':
                    payload = {
                        student_reg: formData.unitStudentReg,
                        unit_name: formData.unitName,
                        unit_code: formData.unitCode,
                        status: 'active'
                    };
                    break;
                case 'promoteStudentForm':
                    payload = {
                        registration_number: formData.promoteStudentReg,  // Updated to match API expectations
                        new_level: formData.newYearSemester
                    };
                    console.log('Student promotion payload:', payload);
                    break;
                case 'grantLeaveForm':
                    payload = {
                        registration_number: formData.leaveStudentReg,
                        start_date: formData.leaveStartDate,
                        end_date: formData.leaveEndDate,
                        reason: formData.leaveReason
                    };
                    break;

                case 'readmitStudentForm':
                    const student = studentsData.find(s => s.registration_number === formData.readmitStudentReg);
                    if (!student) {
                        showStatus(form.querySelector('.status-message').id, 'Student not found', 'error');
                        return;
                    }
                    payload = {};
                    url = `/students/${student.id}/restore`;
                    break;                case 'examCardForm':
                    isFileUpload = true;
                    
                    // Get status message element safely
                    const examCardStatusElement = form.querySelector('.status-message');
                    const examCardStatusId = examCardStatusElement ? examCardStatusElement.id : null;
                    
                    // Validate the file
                    const examCardFile = $('examCardFile');
                    if (!examCardFile || !examCardFile.files || examCardFile.files.length === 0) {
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'Please select a file to upload', 'error');
                        } else {
                            showToast('Please select a file to upload', 'error');
                        }
                        return;
                    }
                    
                    // Validate file type - only PDF allowed
                    const examCardFileType = examCardFile.files[0].type;
                    const allowedTypes = ['application/pdf'];
                    if (!allowedTypes.includes(examCardFileType) && !examCardFile.files[0].name.toLowerCase().endsWith('.pdf')) {
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'Please upload a PDF file only', 'error');
                        } else {
                            showToast('Please upload a PDF file only', 'error');
                        }
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (examCardFile.files[0].size > maxSize) {
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'File size should be less than 5MB', 'error');
                        } else {
                            showToast('File size should be less than 5MB', 'error');
                        }
                        return;
                    }
                    
                    // Ensure properly formatted field names
                    const examCardRegNumber = formData.examCardStudentReg.trim();
                    const fileObj = examCardFile.files[0];
                    
                    // Verify we have valid data before proceeding
                    if (!examCardRegNumber) {
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'Please enter a valid registration number', 'error');
                        } else {
                            showToast('Please enter a valid registration number', 'error');
                        }
                        return;
                    }
                    
                    // Verify file object is valid before creating FormData
                    if (!fileObj || !fileObj.name || fileObj.size === 0) {
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'Invalid file selected. Please try selecting the file again.', 'error');
                        } else {
                            showToast('Invalid file selected. Please try selecting the file again.', 'error');
                        }
                        return;
                    }
                    
                    // Additional file validation
                    if (!fileObj.type && !fileObj.name.toLowerCase().endsWith('.pdf')) {
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'File type could not be determined. Please ensure it is a PDF file.', 'error');
                        } else {
                            showToast('File type could not be determined. Please ensure it is a PDF file.', 'error');
                        }
                        return;
                    }
                    
                    // Create FormData for exam card upload
                    url = '/exam-card';
                    
                    try {
                        payload = new FormData();
                        
                        // Use exact field names expected by the backend API
                        // Try 'registration_number' instead of 'registrationNumber' to match typical backend conventions
                        payload.append('registration_number', examCardRegNumber);
                        payload.append('file', fileObj, fileObj.name);
                        
                        // Verify FormData was created successfully
                        const formDataKeys = [...payload.keys()];
                        const hasRegistration = payload.has('registration_number');
                        const hasFile = payload.has('file');
                        const fileValue = payload.get('file');
                        
                        if (!hasRegistration || !hasFile || !(fileValue instanceof File)) {
                            throw new Error('FormData creation validation failed');
                        }
                        
                        // Additional debugging to inspect FormData before sending
                        debugLog('FormData validation before send:', {
                            registration_number: payload.get('registration_number'),
                            fileExists: payload.get('file') instanceof File,
                            fileName: payload.get('file')?.name,
                            fileSize: payload.get('file')?.size,
                            fileType: payload.get('file')?.type,
                            formDataKeys: formDataKeys,
                            formDataEntries: [...payload.entries()].map(([key, value]) => ({
                                key,
                                valueType: value instanceof File ? 'File' : typeof value,
                                ...(value instanceof File ? { fileName: value.name, fileSize: value.size } : { value })
                            }))
                        });
                        
                        // Log what we're sending with more detail
                        debugLog('Exam card upload details:', {
                            registration_number: examCardRegNumber,
                            file_name: fileObj.name,
                            file_type: fileObj.type,
                            file_size: `${(fileObj.size / 1024).toFixed(2)} KB`,
                            upload_method: 'formdata',
                            endpoint: url,
                            form_id: formId,
                            field_names: formDataKeys,
                            file_has_name: !!fileObj.name,
                            file_has_type: !!fileObj.type,
                            file_is_pdf: fileObj.type === 'application/pdf' || fileObj.name.toLowerCase().endsWith('.pdf')
                        });
                        
                    } catch (formDataError) {
                        console.error('Error creating FormData for exam card:', formDataError);
                        if (examCardStatusId) {
                            showStatus(examCardStatusId, 'Error preparing file upload: ' + formDataError.message, 'error');
                        } else {
                            showToast('Error preparing file upload: ' + formDataError.message, 'error');
                        }
                        return;
                    }
                    break;                case 'feesForm':
                    // Check if there's an optional fees statement file
                    const feesStatementFile = $('feesStatementFile');
                    
                    if (feesStatementFile && feesStatementFile.files && feesStatementFile.files.length > 0) {
                        // File upload case - use unified endpoint
                        isFileUpload = true;
                        
                        // Validate file type - only PDF allowed
                        const feesFileType = feesStatementFile.files[0].type;
                        if (feesFileType !== 'application/pdf' && !feesStatementFile.files[0].name.toLowerCase().endsWith('.pdf')) {
                            showStatus(form.querySelector('.status-message').id, 'Please upload a PDF file only', 'error');
                            return;
                        }
                        
                        // Validate file size (max 5MB)
                        const feesMaxSize = 5 * 1024 * 1024; // 5MB
                        if (feesStatementFile.files[0].size > feesMaxSize) {
                            showStatus(form.querySelector('.status-message').id, 'File size should be less than 5MB', 'error');
                            return;
                        }
                        
                        // Use unified fees-statement endpoint
                        url = '/fees-statement';
                        payload = new FormData();
                        payload.append('registrationNumber', formData.feesStudentReg.trim());
                        payload.append('file', feesStatementFile.files[0]);
                        
                    } else {
                        // No file upload - just JSON data for fees update
                        // NOTE: This will fail unless there's a backend endpoint for updating fees data
                        // You may need to create a separate /fees endpoint in the backend
                        payload = {
                            registration_number: formData.feesStudentReg,
                            fee_balance: parseFloat(formData.feeBalance),
                            total_paid: parseFloat(formData.totalPaid),
                            semester_fee: parseFloat(formData.semesterFee)
                        };
                    }
                    
                    debugLog('Fees update payload:', payload);
                    break;                case 'financeForm':
                    isFileUpload = true;
                    
                    // Validate the file
                    const financeFile = $('financeFile');
                    if (!financeFile || !financeFile.files || financeFile.files.length === 0) {
                        showStatus(form.querySelector('.status-message').id, 'Please select a file to upload', 'error');
                        return;
                    }
                    
                    // Validate registration number
                    if (!formData.financeStudentReg || !formData.financeStudentReg.trim()) {
                        showStatus(form.querySelector('.status-message').id, 'Please enter a registration number', 'error');
                        return;
                    }
                    
                    // Validate document type selection
                    if (!formData.documentType) {
                        showStatus(form.querySelector('.status-message').id, 'Please select a document type', 'error');
                        return;
                    }
                    
                    const financeFileObj = financeFile.files[0];
                    
                    // Enhanced file validation
                    if (!financeFileObj) {
                        showStatus(form.querySelector('.status-message').id, 'No file selected', 'error');
                        return;
                    }
                    
                    // Validate file type - only PDF allowed
                    const financeFileType = financeFileObj.type;
                    const fileName = financeFileObj.name.toLowerCase();
                    if (financeFileType !== 'application/pdf' && !fileName.endsWith('.pdf')) {
                        showStatus(form.querySelector('.status-message').id, 'Please upload a PDF file only', 'error');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    const financeMaxSize = 5 * 1024 * 1024; // 5MB
                    if (financeFileObj.size > financeMaxSize) {
                        showStatus(form.querySelector('.status-message').id, 'File size should be less than 5MB', 'error');
                        return;
                    }
                    
                    // Validate file is not corrupted (basic check)
                    if (financeFileObj.size === 0) {
                        showStatus(form.querySelector('.status-message').id, 'File appears to be empty or corrupted', 'error');
                        return;
                    }
                    
                    // Map document type to unified endpoint
                    if (formData.documentType === 'statement') {
                        url = '/fees-statement';
                    } else if (formData.documentType === 'receipt') {
                        url = '/fees-receipt';
                    } else {
                        showStatus(form.querySelector('.status-message').id, 'Invalid document type selected', 'error');
                        return;
                    }
                    
                    // Create FormData with enhanced validation and logging
                    try {
                        payload = new FormData();
                        
                        // Add fields with validation
                        const regNumber = formData.financeStudentReg.trim();
                        if (regNumber) {
                            payload.append('registrationNumber', regNumber);
                        } else {
                            throw new Error('Registration number is required');
                        }
                        
                        // Add the file with validation
                        if (financeFileObj instanceof File) {
                            payload.append('file', financeFileObj, financeFileObj.name);
                        } else {
                            throw new Error('Invalid file object');
                        }
                        
                        // Add document type for backend processing
                        payload.append('documentType', formData.documentType);
                        
                        // Verify FormData was created correctly
                        const formDataEntries = [...payload.entries()];
                        debugLog('Finance FormData entries:', formDataEntries.map(([key, value]) => ({
                            key,
                            value: value instanceof File ? {
                                name: value.name,
                                type: value.type,
                                size: value.size,
                                lastModified: value.lastModified
                            } : value
                        })));
                        
                        debugLog('Finance unified upload:', {
                            registration_number: regNumber,
                            document_type: formData.documentType,
                            file_name: financeFileObj.name,
                            file_type: financeFileObj.type,
                            file_size: `${(financeFileObj.size / 1024).toFixed(2)} KB`,
                            upload_method: 'formdata',
                            endpoint: url,
                            formdata_fields: formDataEntries.length,
                            has_file_field: formDataEntries.some(([key, value]) => value instanceof File)
                        });
                        
                    } catch (formDataError) {
                        console.error('Error creating FormData:', formDataError);
                        showStatus(form.querySelector('.status-message').id, 'Error preparing file upload: ' + formDataError.message, 'error');
                        return;
                    }
                    break;case 'resultsForm':
                    isFileUpload = true;
                    
                    // Validate the file
                    const resultsFile = $('resultsFile');
                    if (!resultsFile || !resultsFile.files || resultsFile.files.length === 0) {
                        showStatus(form.querySelector('.status-message').id, 'Please select a file to upload', 'error');
                        return;
                    }
                    
                    // Validate file type - only PDF allowed
                    const resultsFileType = resultsFile.files[0].type;
                    if (resultsFileType !== 'application/pdf' && !resultsFile.files[0].name.toLowerCase().endsWith('.pdf')) {
                        showStatus(form.querySelector('.status-message').id, 'Please upload a PDF file only', 'error');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    const resultsMaxSize = 5 * 1024 * 1024; // 5MB
                    if (resultsFile.files[0].size > resultsMaxSize) {
                        showStatus(form.querySelector('.status-message').id, 'File size should be less than 5MB', 'error');
                        return;
                    }
                    
                    const resultsFileObj = resultsFile.files[0];
                    
                    // Use new unified endpoint with FormData
                    url = '/results';
                    payload = new FormData();
                    payload.append('registrationNumber', formData.resultsStudentReg.trim());
                    payload.append('file', resultsFileObj);
                    
                    debugLog('Results unified upload:', {
                        registration_number: formData.resultsStudentReg,
                        file_name: resultsFileObj.name,
                        file_type: resultsFileObj.type,
                        file_size: `${(resultsFileObj.size / 1024).toFixed(2)} KB`,
                        upload_method: 'formdata',
                        endpoint: url
                    });
                    break;                case 'timetableForm':
                    isFileUpload = true;
                    
                    // Validate the file
                    const timetableFile = $('timetableFile');
                    if (!timetableFile || !timetableFile.files || timetableFile.files.length === 0) {
                        showStatus(form.querySelector('.status-message').id, 'Please select a file to upload', 'error');
                        return;
                    }
                    
                    // Validate file type - only PDF allowed
                    const timetableFileType = timetableFile.files[0].type;
                    if (timetableFileType !== 'application/pdf' && !timetableFile.files[0].name.toLowerCase().endsWith('.pdf')) {
                        showStatus(form.querySelector('.status-message').id, 'Please upload a PDF file only', 'error');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    const timetableMaxSize = 5 * 1024 * 1024; // 5MB
                    if (timetableFile.files[0].size > timetableMaxSize) {
                        showStatus(form.querySelector('.status-message').id, 'File size should be less than 5MB', 'error');
                        return;
                    }
                    
                    const timetableFileObj = timetableFile.files[0];
                    
                    // Use new unified endpoint with FormData
                    url = '/timetable';
                    payload = new FormData();
                    payload.append('registrationNumber', formData.timetableStudentReg.trim());
                    payload.append('file', timetableFileObj);
                    
                    debugLog('Timetable unified upload:', {
                        registration_number: formData.timetableStudentReg,
                        file_name: timetableFileObj.name,
                        file_type: timetableFileObj.type,
                        file_size: `${(timetableFileObj.size / 1024).toFixed(2)} KB`,
                        upload_method: 'formdata',
                        endpoint: url
                    });
                    break;
                case 'createUnitForm':
                    payload = {
                        unit_name: formData.createUnitName,
                        unit_code: formData.createUnitCode
                    };
                    debugLog('Create unit payload:', payload);
                    break;
                case 'allocateUnitsForm':
                    // Get selected unit IDs from the units selection checkboxes
                    const selectedUnits = [];
                    const unitCheckboxes = document.querySelectorAll('#unitsToAllocate input[type="checkbox"]:checked');
                    unitCheckboxes.forEach(checkbox => {
                        const unitId = parseInt(checkbox.value);
                        if (!isNaN(unitId)) {
                            selectedUnits.push(unitId);
                        }
                    });
                    
                    if (selectedUnits.length === 0) {
                        showStatus(form.querySelector('.status-message').id, 'Please select at least one unit to allocate', 'error');
                        return;
                    }
                    
                    // Validate other required fields
                    if (!formData.allocateStudentReg || !formData.allocateSemester || !formData.allocateAcademicYear) {
                        showStatus(form.querySelector('.status-message').id, 'Please fill in all required fields', 'error');
                        return;
                    }
                    
                    // Use the registration number-based endpoint
                    url = `/students/registration/${encodeURIComponent(formData.allocateStudentReg.trim())}/allocate-units`;
                    
                    // Create a more robust payload structure
                    payload = {
                        unit_ids: selectedUnits,
                        semester: parseInt(formData.allocateSemester),
                        academic_year: formData.allocateAcademicYear.trim(),
                        notes: formData.allocationNotes ? formData.allocationNotes.trim() : '',
                        // Additional fields that might be expected
                        student_registration: formData.allocateStudentReg.trim(),
                        allocation_type: 'semester'
                    };
                    
                    debugLog('Allocate units payload:', {
                        ...payload,
                        selectedUnitsCount: selectedUnits.length,
                        registrationNumber: formData.allocateStudentReg.trim(),
                        endpoint: url,
                        unitIds: selectedUnits
                    });
                    break;
                case 'viewAllocationsForm':
                    // This case handles viewing allocations - we'll use GET method
                    method = 'GET';
                    
                    // Handle registration numbers with slashes by parsing them
                    const allocationsRegNumber = formData.viewAllocationsStudentReg.trim();
                    if (allocationsRegNumber.includes('/')) {
                        // Registration number has slashes, parse it
                        const parts = allocationsRegNumber.split('/');
                        if (parts.length >= 3) {
                            // Format: course/number/year or course/section/number/year
                            const course = encodeURIComponent(parts[0]);
                            const number = encodeURIComponent(parts.slice(1, -1).join('/'));
                            const year = encodeURIComponent(parts[parts.length - 1]);
                            url = `/students/registration/${course}/${number}/${year}/allocated-units`;
                        } else {
                            // Fallback to simple format if parsing fails
                            url = `/students/registration/${encodeURIComponent(allocationsRegNumber)}/allocated-units`;
                        }
                    } else {
                        // Simple registration number without slashes
                        url = `/students/registration/${encodeURIComponent(allocationsRegNumber)}/allocated-units`;
                    }
                    
                    payload = null; // No payload needed for GET request
                    debugLog('View allocations request:', { studentReg: allocationsRegNumber, url, parts: allocationsRegNumber.split('/') });
                    break;
                default:
                    payload = formData;
            }
            
            // Add loading state to the form
            form.classList.add('submitting');
            const submitBtn = form.querySelector('button[type="submit"]');
            const submitBtnId = submitBtn.id || 'submitBtn'; 
            setLoadingState(submitBtnId, true);
            
            let requestOptions = {
                method
            };
            
            if (isFileUpload) {
                // Check if payload is ArrayBuffer (binary upload) or File object
                if (payload instanceof ArrayBuffer) {
                    // Binary upload with ArrayBuffer
                    requestOptions.body = payload;
                    requestOptions.headers = {
                        'Content-Type': 'application/octet-stream'
                    };
                    
                    debugLog('Sending binary ArrayBuffer request', {
                        url,
                        method,
                        contentType: 'application/octet-stream',
                        payloadSize: `${(payload.byteLength / 1024).toFixed(2)} KB`
                    });
                } else if (payload instanceof File) {
                    // Binary file upload - send file directly
                    requestOptions.body = payload;
                    requestOptions.headers = {
                        'Content-Type': payload.type || 'application/octet-stream'
                    };
                    
                    debugLog('Sending binary file request', {
                        url,
                        method,
                        fileName: payload.name,
                        fileType: payload.type,
                        fileSize: `${(payload.size / 1024).toFixed(2)} KB`,
                        contentType: payload.type || 'application/octet-stream'
                    });
                } else {
                    // FormData upload - DO NOT set Content-Type, let browser handle it
                    requestOptions.body = payload; // FormData object
                    // Explicitly ensure no Content-Type header is set for FormData
                    requestOptions.headers = {};
                    
                    // Log the FormData field names for debugging
                    const formDataFields = [...payload.keys()];
                    const hasFiles = [...payload.values()].some(v => v instanceof File);
                    
                    debugLog('Sending FormData request', {
                        url,
                        method,
                        fields: formDataFields,
                        hasFiles,
                        contentType: 'multipart/form-data (set by browser)'
                    });
                }
            } else {
                // For JSON requests (but not GET requests)
                if (method !== 'GET' && payload !== null) {
                    requestOptions.body = JSON.stringify(payload);
                    requestOptions.headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    debugLog('Sending JSON request', {
                        url,
                        method,
                        payload
                    });
                } else {
                    // GET request or no payload
                    requestOptions.headers = {};
                    
                    debugLog('Sending GET request', {
                        url,
                        method
                    });
                }
            }
            
            const result = await apiRequest(url, requestOptions);
            
            // Remove loading state
            form.classList.remove('submitting');
            setLoadingState(submitBtnId, false, submitBtn.textContent.replace('Processing...', '').trim());
            
            // Find status message element more safely
            const statusMessageElement = form.querySelector('.status-message');
            const statusElementId = statusMessageElement ? statusMessageElement.id : null;
            
            if (result.success) {
                // Special handling for view allocations form
                if (formId === 'viewAllocationsForm') {
                    displayAllocatedUnits(result.data);
                    if (statusElementId) {
                        showStatus(statusElementId, `Found ${result.data.count} allocated units for ${result.data.student.name}`, 'success');
                    }
                    showToast(`Found ${result.data.count} allocated units for ${result.data.student.name}`);
                    // Don't reset the form for view operations
                } else {
                    // Update student status based on form type
                    if (formId === 'grantLeaveForm' && payload.registration_number) {
                        updateStudentStatus(payload.registration_number, 'on-leave');
                    } else if (formId === 'deregisterStudentForm' && formData.deregStudentReg) {
                        updateStudentStatus(formData.deregStudentReg, 'inactive');
                    } else if (formId === 'readmitStudentForm' && formData.readmitStudentReg) {
                        updateStudentStatus(formData.readmitStudentReg, 'active');
                    }
                    
                    if (statusElementId) {
                        showStatus(statusElementId, result.data.message || successMessage, 'success');
                    }
                    showToast(result.data.message || successMessage);
                    form.reset();
                }
            } else {
                if (statusElementId) {
                    showStatus(statusElementId, result.error, 'error');
                }
                showToast(result.error, 'error');
            }
        }

        // Initialize application
        function initializeApp() {
            // Add auto dark mode class to body if user's system prefers dark mode
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('auto-dark-mode');
            }
            
            // Test API connection first (especially important for production)
            testApiConnection();
            
            // Setup file preview for exam card uploads
            setupExamCardFilePreview();
            
            // Setup PDF file preview for all PDF upload forms
            setupPdfFilePreview('financeFile', 'financePreview', 'financeFileInfo');
            setupPdfFilePreview('resultsFile', 'resultsPreview', 'resultsFileInfo');
            setupPdfFilePreview('timetableFile', 'timetablePreview', 'timetableFileInfo');
            setupPdfFilePreview('feesStatementFile', 'feesStatementPreview', 'feesStatementFileInfo');
            
            // Check login status
            const adminToken = localStorage.getItem(ADMIN_TOKEN_KEY);
            if (adminToken) {
                // Verify token validity
                apiRequest('/admin/verify-token')
                    .then(result => {
                        if (result.success) {
                            showDashboard();
                        } else {
                            localStorage.removeItem(ADMIN_TOKEN_KEY);
                            showLogin();
                        }
                    })
                    .catch(() => {
                        localStorage.removeItem(ADMIN_TOKEN_KEY);
                        showLogin();
                    });
            } else {
                showLogin();
            }

            // Bind login form
            $('loginForm').addEventListener('submit', adminLogin);            // Bind dashboard forms
            const forms = [
                { id: 'registerStudentForm', url: '/students', message: 'Student registered successfully!' },
                { id: 'deregisterStudentForm', url: '', method: 'POST', message: 'Student deregistered successfully!' },
                { id: 'grantLeaveForm', url: '/students/academic-leave', message: 'Academic leave granted successfully!' },
                { id: 'registerUnitsForm', url: '/units/register', message: 'Unit registered successfully!' },
                { id: 'promoteStudentForm', url: '/students/promote', message: 'Student promoted successfully!' },
                { id: 'readmitStudentForm', url: '/students/readmit', message: 'Student readmitted successfully!' },
                { id: 'examCardForm', url: '/exam-card', message: 'Exam card uploaded successfully!' },
                { id: 'feesForm', url: '/fees', message: 'Fees updated successfully!' },
                { id: 'financeForm', url: '/finance', message: 'Finance document uploaded successfully!' },
                { id: 'resultsForm', url: '/results', message: 'Results uploaded successfully!' },
                { id: 'timetableForm', url: '/timetable', message: 'Timetable uploaded successfully!' },
                { id: 'createUnitForm', url: '/units', message: 'Unit created successfully!' },
                { id: 'allocateUnitsForm', url: '', message: 'Units allocated successfully!' }, // URL handled dynamically
                { id: 'viewAllocationsForm', url: '', method: 'GET', message: 'Allocations loaded successfully!' } // URL handled dynamically
            ];

            // Bind forms to their respective handlers
            forms.forEach(form => {
                const formElement = $(form.id);
                if (formElement) {
                    formElement.addEventListener('submit', (e) => {
                        e.preventDefault();
                        handleFormSubmission(form.id, form.url, form.method || 'POST', form.message);
                    });
                }
            });
        }

        // Setup exam card file preview functionality
        function setupExamCardFilePreview() {
            const fileInput = $('examCardFile');
            const previewDiv = $('examCardPreview');
            const fileInfoDiv = $('examCardFileInfo');
            
            if (!fileInput || !previewDiv || !fileInfoDiv) return;
            
            fileInput.addEventListener('change', function() {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const file = this.files[0];
                let hasErrors = false;
                
                // Clear previous content
                previewDiv.innerHTML = '';
                fileInfoDiv.innerHTML = '';
                
                if (file) {
                    // Validate file type
                    const allowedTypes = ['application/pdf'];
                    if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.pdf')) {
                        hasErrors = true;
                        fileInfoDiv.innerHTML = `
                            <div class="file-error">
                                <i class="fas fa-exclamation-triangle"></i>
                                Error: Only PDF files are allowed.
                            </div>
                        `;
                        this.setCustomValidity('Only PDF files are allowed.');
                    } else if (file.size > maxSize) {
                        hasErrors = true;
                        fileInfoDiv.innerHTML = `
                            <div class="file-error">
                                <i class="fas fa-exclamation-triangle"></i>
                                Error: File size must be less than 5MB.
                            </div>
                        `;
                        this.setCustomValidity('File size must be less than 5MB.');
                    } else {
                        // File is valid, show preview info
                        fileInfoDiv.innerHTML = `
                            <div class="file-details">
                                <strong>File:</strong> ${file.name}<br>
                                <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                                <strong>Type:</strong> PDF Document
                            </div>
                        `;
                        
                        // Show PDF preview placeholder
                        previewDiv.innerHTML = `
                            <div class="pdf-preview-placeholder">
                                <i class="fas fa-file-pdf"></i>
                                <p>PDF file selected</p>
                                <p class="file-name">${file.name}</p>
                            </div>
                        `;
                    }
                    
                    // If no errors, clear custom validity
                    if (!hasErrors) {
                        this.setCustomValidity('');
                    }
                } else {
                    // No file selected, clear validity
                    this.setCustomValidity('');
                }
            });
        }        // Initialize file preview setup
        document.addEventListener('DOMContentLoaded', function() {
            setupExamCardFilePreview();
            initializeApp();
        });
        
        // Setup PDF file preview functionality (reusable for all PDF forms)
        function setupPdfFilePreview(fileInputId, previewId, infoId) {
            const fileInput = $(fileInputId);
            const previewDiv = $(previewId);
            const fileInfoDiv = $(infoId);
            
            if (!fileInput || !previewDiv || !fileInfoDiv) return;
            
            fileInput.addEventListener('change', function() {
                // Clear previous preview
                previewDiv.innerHTML = '';
                fileInfoDiv.innerHTML = '';
                
                // Clear any custom validity
                this.setCustomValidity('');
                
                if (this.files && this.files.length > 0) {
                    const file = this.files[0];
                    let hasErrors = false;
                    
                    // Display file info
                    const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                    fileInfoDiv.innerHTML = `
                        <div class="file-details">
                            <strong>File:</strong> ${file.name}<br>
                            <strong>Type:</strong> ${file.type}<br>
                            <strong>Size:</strong> ${fileSize}
                        </div>
                    `;
                    
                    // Validate file type - only PDF allowed
                    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                    
                    if (isPdf) {
                        previewDiv.innerHTML = `
                            <div class="pdf-preview">
                                <i class="fas fa-file-pdf pdf-icon"></i>
                                <span>PDF Document</span>
                            </div>
                        `;
                    } else {
                        hasErrors = true;
                        previewDiv.innerHTML = `
                            <div class="invalid-file-preview">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Invalid file type (PDF required)</span>
                            </div>
                        `;
                        
                        fileInfoDiv.innerHTML += `
                            <div class="validation-error">
                                Error: Only PDF files are allowed.
                            </div>
                        `;
                        
                        // Set custom validity to prevent form submission
                        this.setCustomValidity('Only PDF files are allowed.');
                    }
                    
                    // Validate file size (max 5MB)
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        hasErrors = true;
                        fileInfoDiv.innerHTML += `
                            <div class="validation-error">
                                Error: File size must be less than 5MB.
                            </div>
                        `;
                        
                        // Set custom validity to prevent form submission
                        this.setCustomValidity('File size must be less than 5MB');
                    }
                    
                    // If no errors, clear custom validity
                    if (!hasErrors) {
                        this.setCustomValidity('');
                    }
                } else {
                    // No file selected, clear validity
                    this.setCustomValidity('');
                }            });
        }

        // Load available units for allocation
        async function loadAvailableUnits() {
            const unitsContainer = document.getElementById('unitsToAllocate');
            if (!unitsContainer) return;

            try {
                // Show loading state
                unitsContainer.innerHTML = '<div class="loading-message"><i class="fas fa-spinner fa-spin"></i> Loading available units...</div>';
                
                const result = await apiRequest('/units');
                
                if (result.success && result.data && Array.isArray(result.data)) {
                    const units = result.data;
                    
                    if (units.length === 0) {
                        unitsContainer.innerHTML = `
                            <div class="no-units-message">
                                <i class="fas fa-info-circle"></i>
                                <p>No units available. Create units first before allocating them to students.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Create checkboxes for each unit
                    const unitsHTML = units.map(unit => `
                        <div class="unit-checkbox-item">
                            <label class="unit-checkbox-label">
                                <input type="checkbox" value="${unit.id}" data-unit-code="${unit.unit_code}" data-unit-name="${unit.unit_name}">
                                <span class="unit-info">
                                    <strong>${unit.unit_code}</strong> - ${unit.unit_name}
                                </span>
                            </label>
                        </div>
                    `).join('');
                    
                    unitsContainer.innerHTML = `
                        <div class="units-selection-container">
                            <div class="units-selection-header">
                                <span>Select units to allocate to the student:</span>
                                <div class="units-selection-actions">
                                    <button type="button" class="btn-link" onclick="selectAllUnits()">Select All</button>
                                    <button type="button" class="btn-link" onclick="clearAllUnits()">Clear All</button>
                                </div>
                            </div>
                            <div class="units-checkbox-list">
                                ${unitsHTML}
                            </div>
                        </div>
                    `;
                    
                    debugLog('Available units loaded:', {
                        count: units.length,
                        units: units.map(u => ({ code: u.unit_code, name: u.unit_name }))
                    });
                } else {
                    console.warn('Failed to load units:', result.error);
                    unitsContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load available units. Please try refreshing the page.</p>
                            <button type="button" class="btn btn-outline" onclick="loadAvailableUnits()">
                                <i class="fas fa-retry"></i> Retry
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading units:', error);
                unitsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading units: ${error.message}</p>
                        <button type="button" class="btn btn-outline" onclick="loadAvailableUnits()">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Helper functions for unit selection
        function selectAllUnits() {
            const checkboxes = document.querySelectorAll('#unitsToAllocate input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function clearAllUnits() {
            const checkboxes = document.querySelectorAll('#unitsToAllocate input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // Load units when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load available units for allocation
            loadAvailableUnits();
        });
    </script>
  
</body>
</html>